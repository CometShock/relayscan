{{ $lastUpdateTime := .LastUpdateTime }}
{{ $timeInitial := .StatsTimeInitial }}
{{ $viewInitial := .InitialView }}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/styles.css?v=6">

    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">

    <!-- HTML Meta Tags -->
    <title>relayscan.io – MEV-Boost Relay & Builder Stats</title>
    <meta name="description" content="Monitoring, analytics & data for MEV-Boost Builders and Relays on Ethereum">

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://www.relayscan.io">
    <meta property="og:type" content="website">
    <meta property="og:title" content="relayscan.io – MEV-Boost Relay & Builder Stats">
    <meta property="og:description" content="Monitoring, analytics & data for MEV-Boost Builders and Relays on Ethereum">
    <meta property="og:image" content="https://relayscan.io/static/images/ogimage.jpg">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="relayscan.io">
    <meta property="twitter:url" content="https://www.relayscan.io">
    <meta name="twitter:title" content="relayscan.io – MEV-Boost Relay & Builder Stats">
    <meta name="twitter:description" content="Monitoring, analytics & data for MEV-Boost Builders and Relays on Ethereum">
    <meta name="twitter:image" content="https://relayscan.io/static/images/ogimage.jpg">
</head>

<body>
    <div class="header">
        <div class="home-menu pure-menu pure-menu-horizontal">
            <a class="pure-menu-heading" href="">relayscan.io</a>

            <ul class="pure-menu-list">
                <li class="pure-menu-item"><a href="https://hackmd.io/XfSCHCb7RfOzjub72s54eg" class="pure-menu-link">About</a></li>
                <li class="pure-menu-item"><a href="/api/stats" class="pure-menu-link">API</a></li>
                <li class="pure-menu-item"><a href="https://twitter.com/relayscan_io" class="pure-menu-link"><i class="bi bi-twitter"></i></a></li>
            </ul>
        </div>
    </div>

    <div class="content">
        <div style="text-align: center; margin-bottom:60px;">
            <h1 style="margin-bottom:10px;">Relay & Builder Stats</h1>
            <!-- <h2 style="margin-bottom:10px;">24h Stats</h2> -->

            <p style="color: #6d6d6d;">
                <small>updated {{ .LastUpdateTime }} UTC</small>
            </p>
            <p id="view-type">
                <a href="javascript:showOverview(true)" id="a-view-type-overview" class="active">Overview</a>
                &middot;
                <a href="javascript:showProfitability(true)" id="a-view-type-profitability">Builder Profitability</a>
            </p>
            <p id="stats-time">
                {{ range $index, $timerange := .StatsTimeSpans }}
                {{ if ne $index 0 }} &middot; {{ end }}
                <a href="javascript:setStatsTime('{{ $timerange }}', true)" id="stats-time-pick-{{ $timerange }}" class="stats-time-pick {{ if eq $timerange $timeInitial }}active{{ end }}">{{ $timerange }}</a>
                {{ end }}
            </p>
        </div>

        <div class="pure-g" id="content-overview">
            <div class=" pure-u-1 pure-u-md-1-2 stats-table" id="stats-relays">
                <div>
                    <h2 id="header-top-relays">
                        <div id="copy-relays-to-clipboard">
                            <a href="javascript:void(0)" onclick="copyRelays(event)" title="Copy relays as markdown to clipboard"><i id="copy-relays-to-clipboard-icon" class="bi bi-clipboard"></i></a>
                        </div>

                        Top Relays
                    </h2>
                    <table class="pure-table pure-table-horizontal">
                        <thead>
                            <tr>
                                <th>Relay</th>
                                <th>Payloads</th>
                                <th>Percent</th>
                            </tr>
                        </thead>
                        {{ range $timerange, $stats := .Stats }}
                        <tbody id="tbody-relays-{{ $timerange }}" class="tbody-relays" {{ if ne $timerange $timeInitial }} style="display: none;" {{ end }}>
                            {{ range $stats.TopRelays }}
                            <tr class="tr-relay" onmouseover="relayMouseOver('{{.Relay}}')" onmouseout="relayMouseOut('{{.Relay}}')">
                                <td>{{ .Relay }}</td>
                                <td style="text-align:right">{{ .NumPayloads | prettyInt }}</td>
                                <td style="text-align:right">{{ .Percent }} %</td>
                            </tr>
                            {{ end }}
                        </tbody>
                        {{ end }}
                    </table>
                </div>
            </div>

            <div class="pure-u-1 pure-u-md-1-2 stats-table" id="stats-builders">
                <div>
                    <h2 id="header-top-builders">
                        <div id="copy-builders-to-clipboard">
                            <a href="javascript:void(0)" onclick="copyBuilders(event)" title="Copy builders as markdown to clipboard"><i id="copy-builders-to-clipboard-icon" class="bi bi-clipboard"></i></a>
                        </div>
                        Top Builders
                    </h2>

                    <table class="pure-table pure-table-horizontal">
                        <thead>
                            <tr>
                                <th>Builder extra_data</th>
                                <th>Blocks</th>
                                <th style="min-width: 100px;">Percent</th>
                            </tr>
                        </thead>
                        {{ range $timerange, $stats := .Stats }}
                        <tbody id="tbody-builders-{{ $timerange }}-all" class="tbody-builders" {{ if ne $timerange $timeInitial }} style="display: none;" {{ end }}>
                            {{ range $stats.TopBuilders }}
                            <tr>
                                <td>
                                    {{ if .ExtraData }}{{ .ExtraData }}{{ else }}&nbsp;{{ end }}
                                    {{ if ne (len .Aliases) 0 }}
                                    <i id="icon-tooltip-builder-alias-{{ $timerange }}" class="tooltip-icon bi bi-info-circle" aria-describedby="tooltip-builder-alias-{{ $timerange }}"></i>
                                    <div id="tooltip-builder-alias-{{ $timerange }}" class="tooltip builder-aliases" role="tooltip">
                                        <b>extra_data values:</b>
                                        <ul>
                                            {{ range .Aliases }}
                                            <li>{{ . }}</li>
                                            {{ end }}
                                        </ul>
                                        <div id="arrow" data-popper-arrow></div>
                                    </div>
                                    {{ end }}

                                </td>
                                <td style="text-align:right">{{ .NumBlocks | prettyInt }}</td>
                                <td style="text-align:right">{{ .Percent }} %</td>
                            </tr>
                            {{ end }}
                        </tbody>

                        {{ range $relay, $builders := $stats.TopBuildersByRelay }}
                        <tbody id="tbody-builders-{{ $timerange }}-{{ $relay }}" class="tbody-builders" style="display:none;">
                            {{ range $builders }}
                            <tr>
                                <td>
                                    {{ if .ExtraData }}{{ .ExtraData }}{{ else }}&nbsp;{{ end }}
                                </td>
                                <td style="text-align:right">{{ .NumBlocks | prettyInt }}</td>
                                <td style="text-align:right">{{ .Percent }} %</td>
                            </tr>
                            {{ end }}
                        </tbody>
                        {{ end }}
                        {{ end }}
                    </table>

                </div>
            </div>
        </div>

        <div id="content-profitability" {{ if eq $viewInitial "overview" }}style="display: none;" {{ end }}>
            {{ range $timerange, $stats := .Stats }}
            <table id="table-builderprofit-{{ $timerange }}" class="table-builderprofit sortable pure-table pure-table-horizontal pure-table-striped" {{ if ne $timerange $timeInitial }} style="display: none;" {{ end }}>
                <thead>
                    <tr>
                        <th>Builder extra_data</th>
                        <th>Blocks</th>
                        <th>Blocks with profit</th>
                        <th>Blocks with subsidy</th>
                        <th>Avg. profit / block</th>
                        <th>Profit total</th>
                        <th>Subsidies total</th>
                    </tr>
                </thead>
                <tbody>
                    {{ range $stats.BuilderProfits }}
                    <tr>
                        <td class="builder-extradata">
                            {{ if .ExtraData }}<span style="white-space: pre;">{{ .ExtraData }}</span>{{ else }}&nbsp;{{ end }}
                            {{ if ne (len .Aliases) 0 }}
                            <i id="icon-tooltip-builderprofit-alias-{{ $timerange }}" class="tooltip-icon bi bi-info-circle" aria-describedby="tooltip-builderprofit-alias-{{ $timerange }}"></i>
                            <div id="tooltip-builderprofit-alias-{{ $timerange }}" class="tooltip builder-aliases" role="tooltip">
                                <b>extra_data values:</b>
                                <ul>
                                    {{ range .Aliases }}
                                    <li>{{ . }}</li>
                                    {{ end }}
                                </ul>
                                <div class="arrow" data-popper-arrow></div>
                            </div>
                            {{ end }}
                        </td>
                        <td class="td-num-blocks" data-sort="{{ .NumBlocks }}">{{ .NumBlocks | prettyInt }}</td>
                        <td class="td-num-blocks-profit" data-sort="{{ .NumBlocksProfit }}">{{ .NumBlocksProfit | prettyInt }}</td>
                        <td class="td-num-blocks-subs" data-sort="{{ .NumBlocksSubsidised }}">{{ .NumBlocksSubsidised | prettyInt }}</td>
                        <td>{{ .ProfitPerBlockAvg }}</td>
                        <td>{{ .ProfitTotal }}</td>
                        <td>{{ .SubsidiesTotal }}</td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
            {{ end }}
        </div>


    </div> <!-- end of content -->

    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script>
        const tooltips = [
            {{ range $timerange, $stats:= .Stats }}
        ['#icon-tooltip-builder-alias-{{ $timerange }}', '#tooltip-builder-alias-{{ $timerange }}'],
            ['#icon-tooltip-builderprofit-alias-{{ $timerange }}', '#tooltip-builderprofit-alias-{{ $timerange }}'],
            {{ end }}
        ]

        const showEvents = ['mouseenter', 'focus'];
        const hideEvents = ['mouseleave', 'blur'];

        tooltips.forEach(([trigger, tooltip]) => {
            const elTrigger = document.querySelector(trigger);
            const elTooltip = document.querySelector(tooltip);
            const popperInstance = Popper.createPopper(elTrigger, elTooltip, { modifiers: [{ name: 'offset', options: { offset: [0, 8] } }], });
            function showTooltip() {
                elTooltip.setAttribute('data-show', ''); // Show the tooltip
                popperInstance.setOptions((options) => ({ ...options, modifiers: [...options.modifiers, { name: 'eventListeners', enabled: true },] }));
                popperInstance.update(); // Update its position
            }
            function hideTooltip() {
                elTooltip.removeAttribute('data-show'); // Hide the tooltip
                popperInstance.setOptions((options) => ({ ...options, modifiers: [...options.modifiers, { name: 'eventListeners', enabled: false }] }));
            }
            showEvents.forEach((event) => {
                elTrigger.addEventListener(event, showTooltip);
            });

            hideEvents.forEach((event) => {
                elTrigger.addEventListener(event, hideTooltip);
            });

        })


        // Relay mouseover -> update buolders
        // activeRelay = ""
        currentTimeSpan = "{{ $timeInitial }}"
        currentView = "{{ $viewInitial }}"

        showBuildersForRelay = function (relay) {
            // hide all builders
            for (const topBuildersTbody of document.getElementsByClassName("tbody-builders")) {
                topBuildersTbody.style.display = "none";
            }

            // show specific builder
            if (relay == "") {
                document.getElementById("tbody-builders-" + currentTimeSpan + "-all").style.display = "table-row-group";
            } else {
                document.getElementById("tbody-builders-" + currentTimeSpan + "-" + relay).style.display = "table-row-group";
            }
        }

        relayMouseOver = function (relay) {
            showBuildersForRelay(relay)
        }

        relayMouseOut = function (relay) {
            showBuildersForRelay("")
        }

        // COPY TABLES AS MARKDOWN TO CLIPBOARD
        copyBuilders = function (e) {
            e.stopPropagation();
            var md = document.getElementById("md-builders-" + currentTimeSpan).innerHTML;
            navigator.clipboard.writeText(md);
            document.getElementById("copy-builders-to-clipboard-icon").classList.remove("bi-clipboard");
            document.getElementById("copy-builders-to-clipboard-icon").classList.add("bi-clipboard-check");
            setTimeout(function () {
                document.getElementById("copy-builders-to-clipboard-icon").classList.remove("bi-clipboard-check");
                document.getElementById("copy-builders-to-clipboard-icon").classList.add("bi-clipboard");
            }, 1000);
        }

        copyRelays = function (e) {
            e.stopPropagation();
            var md = document.getElementById("md-relays-" + currentTimeSpan).innerHTML;
            navigator.clipboard.writeText(md);
            document.getElementById("copy-relays-to-clipboard-icon").classList.remove("bi-clipboard");
            document.getElementById("copy-relays-to-clipboard-icon").classList.add("bi-clipboard-check");
            setTimeout(function () {
                document.getElementById("copy-relays-to-clipboard-icon").classList.remove("bi-clipboard-check");
                document.getElementById("copy-relays-to-clipboard-icon").classList.add("bi-clipboard");
            }, 1000);
        }

        // Setting stats time
        setStatsTime = function (time, doUpdateLocation) {
            // update time picker
            for (const statsTimePick of document.getElementsByClassName("stats-time-pick")) {
                statsTimePick.classList.remove("active");
            }
            document.getElementById("stats-time-pick-" + time).classList.add("active");

            // update relays
            for (const statsTimePick of document.getElementsByClassName("tbody-relays")) {
                statsTimePick.style.display = "none"
            }
            document.getElementById("tbody-relays-" + time).style.display = "table-row-group"

            // update builders
            for (const statsTimePick of document.getElementsByClassName("tbody-builders")) {
                statsTimePick.style.display = "none"
            }
            document.getElementById("tbody-builders-" + time + "-all").style.display = "table-row-group"

            // update builderprofits
            for (const statsTimePick of document.getElementsByClassName("table-builderprofit")) {
                statsTimePick.style.display = "none"
            }
            document.getElementById("table-builderprofit-" + time).style.display = "table-row-group"

            currentTimeSpan = time
            if (doUpdateLocation) {
                updateLocation()
            }
        }

        updateLocation = function () {
            window.history.replaceState({}, document.title, "?t=" + currentTimeSpan + "&v=" + currentView);
        }

        window.onload = function () {
            // show all builders
            timeSpan = getQueryVariable("t")
            if (timeSpan != null) {
                setStatsTime(timeSpan, false)
            }

            const view = getQueryVariable("v")
            console.log("view", view)
            if (view == "profitability") {
                showProfitability(false)
            }
        }

        showOverview = function (doUpdateLocation) {
            document.getElementById("content-profitability").style.display = "none";
            document.getElementById("content-overview").style.display = "flex";
            document.getElementById("a-view-type-overview").classList.add("active");
            document.getElementById("a-view-type-profitability").classList.remove("active");
            currentView = "overview"
            if (doUpdateLocation) {
                updateLocation()
            }
        }

        showProfitability = function (doUpdateLocation) {
            document.getElementById("content-profitability").style.display = "block";
            document.getElementById("content-overview").style.display = "none";
            document.getElementById("a-view-type-overview").classList.remove("active");
            document.getElementById("a-view-type-profitability").classList.add("active");
            currentView = "profitability"
            if (doUpdateLocation) {
                updateLocation()
            }
        }

        getQueryVariable = function (variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null
        }
    </script>

    <div style="display: none;">
        {{ range $timerange, $stats := .Stats }}
        <pre id="md-relays-{{ $timerange }}">{{ .TopRelays | relayTable}}
Top relays - {{ $timerange }}, {{ $lastUpdateTime }} UTC, via [relayscan.io](https://relayscan.io)</pre>
        <pre id="md-builders-{{ $timerange }}">{{ .TopBuilders | builderTable}}
Top builders - {{ $timerange }}, {{ $lastUpdateTime }} UTC, via [relayscan.io](https://relayscan.io)</pre>
        {{ end }}
    </div>

    <!-- <link href="https://cdn.jsdelivr.net/gh/tofsjonas/sortable/sortable.min.css" rel="stylesheet" /> -->
    <script src="/static/sortable.min.js"></script>
</body>

</html>